<!-- auth/callback.html -->
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MediConnect - Procesando autenticación</title>
    <link rel="stylesheet" href="../css/main.css">
    <style>
        .loading-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            padding: 20px;
            text-align: center;
        }
        
        .spinner {
            width: 50px;
            height: 50px;
            border: 5px solid #f3f3f3;
            border-top: 5px solid var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .message {
            font-size: 18px;
            color: var(--dark);
            max-width: 600px;
        }
        
        .error-container {
            display: none;
            margin-top: 20px;
            padding: 15px;
            background-color: #ffebee;
            border-radius: 4px;
            color: var(--error);
        }
    </style>
</head>
<body>
    <div class="loading-container">
        <div class="spinner"></div>
        <div class="message">Procesando la autenticación, por favor espere...</div>
        <div id="error-container" class="error-container"></div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Obtener parámetros de URL
            const params = new URLSearchParams(window.location.search);
            const code = params.get('code');
            const state = params.get('state');
            const error = params.get('error');
            const errorDescription = params.get('error_description');
            
            // Verificar si hay errores en la respuesta
            if (error) {
                handleError(`Error: ${error} - ${errorDescription || 'No hay descripción disponible'}`);
                return;
            }
            
            // Verificar si hay código de autorización
            if (!code) {
                handleError('No se recibió el código de autorización.');
                return;
            }
            
            // Verificar el estado para protección CSRF
            const storedState = localStorage.getItem('oauth_state');
            if (state !== storedState) {
                handleError('Error de seguridad: el estado no coincide (posible ataque CSRF).');
                return;
            }
            
            // Limpiar el estado ya que se usó
            localStorage.removeItem('oauth_state');
            
            // Intercambiar código por token
            exchangeCodeForToken(code);
        });
        
        async function exchangeCodeForToken(code) {
            try {
                const tokenEndpoint = 'http://localhost:8080/hapi-fhir-jpaserver/oauth/token';
                const clientId = 'mediconnect-client';
                const redirectUri = 'http://localhost/auth/callback.html';
                
                const response = await fetch(tokenEndpoint, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded'
                    },
                    body: new URLSearchParams({
                        grant_type: 'authorization_code',
                        code: code,
                        client_id: clientId,
                        redirect_uri: redirectUri
                    })
                });
                
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error_description || 'Error al intercambiar código por token.');
                }
                
                const data = await response.json();
                
                // Almacenar tokens en localStorage
                const expiresAt = Date.now() + data.expires_in * 1000;
                localStorage.setItem('access_token', data.access_token);
                localStorage.setItem('refresh_token', data.refresh_token);
                localStorage.setItem('expires_at', expiresAt);
                
                // Obtener información del usuario
                await fetchUserInfo(data.access_token);
                
                // Redirigir al dashboard
                window.location.href = '/dashboard.html';
                
            } catch (error) {
                handleError(`Error en la autenticación: ${error.message}`);
            }
        }
        
        async function fetchUserInfo(accessToken) {
            try {
                const response = await fetch('http://localhost:8080/hapi-fhir-jpaserver/fhir/Practitioner/$current', {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${accessToken}`,
                        'Content-Type': 'application/fhir+json'
                    }
                });
                
                if (!response.ok) {
                    throw new Error('Error al obtener información del usuario');
                }
                
                const userInfo = await response.json();
                localStorage.setItem('user_info', JSON.stringify(userInfo));
                
            } catch (error) {
                console.error('Error al obtener información del usuario:', error);
                // No fallar por completo si no se puede obtener información del usuario
            }
        }
        
        function handleError(message) {
            const spinner = document.querySelector('.spinner');
            const messageElement = document.querySelector('.message');
            const errorContainer = document.getElementById('error-container');
            
            // Ocultar spinner
            spinner.style.display = 'none';
            
            // Cambiar mensaje
            messageElement.textContent = 'Ha ocurrido un error durante la autenticación.';
            
            // Mostrar error
            errorContainer.style.display = 'block';
            errorContainer.innerHTML = `
                <p>${message}</p>
                <button class="btn btn-primary" style="margin-top: 15px;" onclick="window.location.href='/auth/login.html'">
                    Volver al inicio de sesión
                </button>
            `;
        }
    </script>
</body>
</html>